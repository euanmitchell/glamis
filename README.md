# Spatial Algorithms

## Overview

This directory contains code for algorithms that seek to increase the *effective* beam sensitivity of the lidar by correcting the ground elevations returned by ```gediMetric```. It contains a variety of small plotting and helper scripts, as well as the main ```groundFinder.py``` program:

* ```alsPlots.py``` - script that reads a single summary text file per site and produces 4x2 histogram plots of ALS cover and canopy height (RH95). Can also produce histograms of ground slope if slope rasters are available (most easily made in QGIS from the ALS true ground raster generated by ```groundFinder.py```).
* ```coverStats.py``` - original script to read output of ```gediMetric``` with just the ALS ('true') metrics and generate maps of canopy cover and contiguous regions exceeding a specified cover threshold.
* ```gawk.py``` - generates a shell script to automatically concatenate the text files produced by ```gediMetric``` and gawk selected metrics to a new text file.
* ```gediRat.py``` - generates a shell script to execute ```gediRat``` in 1.2 x 1.2 km tiles over an ALS data set.
* ```gridMetricNoise.sh``` - an example shell script with the denoising parameters needed for ```gediMetric``` to reproduce the 11 signal processing algorithms used.
* ```groundFinder.py``` - the main script for running the new ground-finding algorithms.
* ```groundFinderSummary.py``` - script to produce the summary beam sensitivity vs. RMSE & bias plots. Requires a summary text file for each site.
* ```plotWaves.py``` - script to plot waveforms from ```gediRat``` or ```addNoiseHDF``` and add ALS ground, signal processing algorithm ground estimates, and newGround value if available.
* ```rasterTools.py``` - a library of functions for working with raster data, imported by ```groundFinder.py```.

### Generating the Raw Data

The scripts in this directory are intended to work with simulated, large-footprint, waveform lidar data generated from ALS point clouds using a [lidar simulator](https://bitbucket.org/StevenHancock/gedisimulator).

The ```gediRat.py``` script can be used to produce raw, noise-free, simulated waveforms. This script must be manually edited to provide the bounding box lat/long of the ALS data, as well as the location of the ALS *groundBounds.txt* file and a path/filename for the shell script produced. Executing this shell script will run the GEDI Simulator ```gediRat``` program with the parameters specified in ```gediRat.py```.

The HDF5 files of simulated waveforms created by ```gediRat``` can be noised and subsequently denoised with the GEDI Simulator ```gediMetric``` program. An example shell script for running ```gediMetric``` with one full set of denoising parameters (i.e., all 11 signal processing algorithms used in the original study) is provided in ```gridMetricNoise.sh```.  

The ```gawk.py``` script generates a shell script that will automatically concatenate the individual text files output by ```gediMetric``` into a single text file and subsequently gawk selected metrics into a new summary text file for each set of denoising parameters. These summary text files are then read into ```groundFinder.py```. **IMPORTANT:** The ```groundFinder.py``` script is set-up to expect certain metrics from ```gediMetric``` to be in the text file columns defined by this script. Reading other text files into ```groundFinder.py``` will require manual editing of the ```loadData()``` method.

### Directory Structure

The various scripts in this directory are set-up to read/write from/to data files sitting within a strictly defined directory structure. The complete path that ```groundFinder.py``` expects for the summary text file produced by ```gediMetric``` for a single site with a given grid size and set of denoising parameters is:

> ```/exports/csce/datastore/geos/groups/3d_env/data/glamis/emitchell/noisedGrids/{siteName}/grid{gridSize}/metric{beamSensitivity}-{algorithmNumber}/metric{gridSize}-{beamSensitivity}-{algorithmNumber}Summary.txt```

For example, the ```gediMetric``` output from the 30 m grid at La Selva, for 98% beam sensitivity, with the denoising parameters as defined by Algorithm \#1, would be read by ```groundFinder.py``` after concatenating and gawking as in ```gawk.py``` from:

> ```/exports/csce/datastore/geos/groups/3d_env/data/glamis/emitchell/noisedGrids/laselva/grid30/metric98-1/metric30-98-1Summary.txt```

The site name, beam sensitivity, and grid size can be specified from the command line options for ```groundFinder.py``` but the structure of the path and file name is fixed. Changing the input text file naming convention will require manual editing of the ```loadData()``` method.

## Running the Scripts

### ```groundFinder.py```

This is the main program that runs a variety of algorithms, which seek to generate new ground elevation estimates for individual footprints that are considered inaccurate by interpolating off the remaining, accurate footprints.

It defines a class, ```groundFinder```, which automatically runs the ```loadData()``` method and optionally any or all of the ```plotGroundRange()```, ```stdDevRasters()```, and ```updateGround()``` methods, as defined below.

#### ```loadData()```:

This method reads a text file for each of the 9 or 11 algorithms used and re-shapes the resulting NumPy array into a 3-D data cube, with the rows and columns corresponding to the latitude and longitude of the footprints. Each ```gediMetric``` output metric is then available as a layer in this cube. A range of further 2-D and 3-D NumPy arrays are then extracted and/or stacked from these original data cubes into variables. The basic statistics (RMSE, bias, outlier fraction) of each of the algorithms are computed and printed.

#### ```plotGroundRange()```:

This method is called with *--plots* and can write to *--plotRoot* a variety of histogram, scatter, and box plots of the data as described in the following command line options section. These plotting functions are intended to accept only the input from the original 9 algorithms and should not be called with the *--varScale* option.

#### ```stdDevRasters()```:

A single command line option *--sdRaster* calls this method and writes five GeoTiffs to *--plotRoot* as described below.

#### ```updateGround()```:

The main method that attempts to correct the ground elevation of target footprints using one of the ground-finding algorithms specified by *--updateMethod*. Target footprints are identified as having a standard deviation of ground elevation values among the nine original algorithms (#1-9 in ```gridMetricNoise.sh```) > *--sdThresh*. A brief description of each available *--updateMethod* follows:
* #### Ground-Finding Algorithms:
  * --mean - calculates the mean of the *--prefAlgm* ground elevations for all neighbouring footprints with std. dev. < *--sdThresh* within the smallest search window that generates more than *-fThresh* accurate footprints.
  * --nearest - takes the value (or mean) of the *--prefAlgm* ground elevations for the nearest neighbour footprint(s) with std. dev. < *--sdThresh* within the smallest search window that generates more than *-fThresh* accurate footprints.
  * --linear - fits a linear plane (i.e., 1st-order polynomial) to all neighbouring footprints with std. dev. < *--sdThresh* within the smallest search window that generates more than *-fThresh* accurate footprints and evaluates at the target footprint.
  * --quadratic - finds the *-fThresh* nearest neighbours with std. dev. < *--sdThresh* to the target footprint and, for each of these neighbours, fits a quadratic surface (i.e., 2nd-order polynomial) to their *-fThresh* nearest neighbours with std. dev. < *--sdThresh*. Each of these surfaces is evaluated at the target footprint and a mean of these values taken.
  * --natural - performs a cubic spline interpolation to every footprint in the data set with std. dev. < *--sdThresh* using the *scipy.interpolate.griddata(method='cubic')* function.
  * --hybrid - runs the *--natural* method (**without** simulating the *--forceToWave* option) and the *--mean* method (**with** simulating the *--forceToWave* option, and using all 11 algorithms). Then chooses between these two results on a footprint-by-footprint basis for all target footprints, based on the result of the *--natural* calculation and the total range in ground elevations encompassed by the 11 algorithms. If the *--natural* values lies outwith this total range, that value is disregarded and the result of the *--mean* method is used, otherwise the results of the *--natural* method is used. Requires *--varScale* to run correctly.
  * --height - experimental method based on mean canopy height.
  * --amplitude - experimental method based on probability of a feature being real from calculated Gaussian amplitude and noise distribution.
  * --idealAll - calculates a hypothetical best result by selecting the ground elevation estimate that is closest to ALS true ground for every footprint in the data set.
  * --ideal - calculates a hypothetical result by selecting the ground elevation estimate that is closest to ALS true ground for every target (std. dev. >= *--sdThresh*) footprint in the data set.

The following command line options are available:
* #### General Options:
  * --suppress - Flag to suppress "RuntimeWarnings" in code. Default is **False**.
  * --site - Shortcut to set *--rootDir*, *--name*, *--epsg*, and *--plotRoot* for a whole field site. Valid values are: laselva, robson, nouragues, paracou, hubbard, windriver, oakridge. New sites and values can be added in the *__ main __* block. Default is not set.
  * --name - The name of the site, set by *--site*. Default is not set.
  * --rootDir - The root directory to look in for sub-directories with individual gediMetric output text files. Sub directories should follow the naming convention: "metric{*--covThresh*}-n" and text files should follow the naming convention: "metric{*--gridSize*}-{*--covThresh*}-nSummary.txt" where n is an integer identifier. Default is **/exports/csce/datastore/geos/groups/3d_env/data/glamis/emitchell/noisedGrids/laselva/grid30/**.
  * --epsg - EPSG code of the data. Default is **32616**.
  * --plotRoot - The root of the directory to save plots and tiffs to. Default is **../data/laSelvaGroundError/30-98/**.
  * --gridSize - The spacing in metres between footprints. Default is **30**.
  * --covThresh - The canopy cover threshold for input data sets (i.e., the ```gediMetric``` *-linkNoise* beam sensitivity). Default is **98**.
  * --varScale - Flag to use data from additional algorithms with varScale = 1 and varScale = 1.5. Default is **False**.
  * --outlierThresh - The threshold distance, in metres from the mean, for calculating the outlier proportion beyond. Default is **10**.
  * --sdThresh - The standard deviation threshold for generating binary and region rasters and identification of accurate footprints for *--fThresh*. Default is **3.0**.
* #### Plotting Options:
  * --plots - Flag to run ```plotGroundRange()``` to make plots for different algorithm settings. Default is **False**. Specify the plots to generate with one or more of the following nine flags.
  * --groundHist - Flag to generate 3x3 ground elevation histogram plot for each of the nine different algorithm settings. Plot is written to *--plotRoot+'GroundHist_All_Scaled.png'*. Default is **False**.
  * --sdHist - Flag to generate a single histogram of ground standard deviation for the nine algorithms. Plot is written to *--plotRoot+'StdDevHist.png'*. Default is **False**.
  * --errorHist - Flag to generate 3x3 ground error histogram plot for each of the nine different algorithm settings. Plot is written to *--plotRoot+'ErrorHistSD{--sdThresh}_All_Unscaled.png'*. Default is **False**.
  * --sdScatter - Flag to generate standard deviation vs. ground error scatter plots for each of the nine different algorithm settings. Plot is written to *--plotRoot+'Scatter_All_Scaled.png'*. Default is **False**.
  * --sdBox - Flag to generate standard deviation vs. ground error box plots for each of the nine different algorithm settings. Boxes are drawn in 1 m increments from 0 - 15 m std. dev. Plot is written to *--plotRoot+'Box_All_Scaled.png'*. Default is **False**.
  * --fhdHist - Flag to generate 3x3 foliage height diversity histogram plot for each of the nine different algorithm settings. Plot is written to *--plotRoot+'FHDHist_All_Scaled.png'*. Default is **False**.
  * --coverHist - Flag to generate ALS canopy cover histogram plots with all data, < 3 m std. dev. data, and < 1 m std. dev. data. Plot showing only cover > 0.8 data is written to *--plotRoot+'canopyCoverHighHistComp.png'*. Plot showing cover > 0.0 data is written to *--plotRoot+'canopyCoverHistComp.png'*. Default is **False**.
  * --heightHist - Flag to generate ALS canopy height (RH98) histogram plot with all data, < 3 m std. dev. data, and < 1 m std. dev. data. Plot is written to *--plotRoot+'alsHeightHistComp.png'*. Default is **False**.
  * --rh50Hist - Flag to generate ALS RH50 histogram plot with all data, < 3 m std. dev. data, and < 1 m std. dev. data. Plot is written to *--plotRoot+'alsRH50HistComp.png'*. Default is **False**.
* #### Raster Options:
  * --sdRaster - Flag to run ```stdDevRasters()``` to generate rasters from standard deviation array. Default is **False**. The following rasters are produced:
    * ALS cover raster written to *--plotRoot+'ALSCover.tif'*.
    * ALS true ground raster written to *--plotRoot+'ALSGround.tif'*.
    * Standard deviation raster written to *--plotRoot+'StdDev.tif'*.
    * Binary standard deviation raster (0 where < *--sdThresh*; 1 where >= *--sdThresh*) written to *--plotRoot+'binaryStdDevSD{--sdThresh}BS{--covThresh}.tif'*.
    * Regions raster (calls ```rasterTools.py``` ```defineRegions()``` method to identify contiguous square areas of varying size in binary std. dev. raster) written to *--plotRoot+'HighStdRegions.tif'*.
* #### Update Options:
  * --update - Flag to run ```updateGround()``` to correct high standard deviation cells from the standard deviation array using one of the algorithms specified by *--updateMethod*. Default is **False**.
  * --updateMethod - Choose the method for estimating ground elevation at high std. dev. footprints. Valid values are: hybrid, ideal, idealAll, mean, nearest, natural, linear, quadratic, height, amplitude. Default is **mean**.
  * --fThresh - The threshold number of neighbouring low std. dev. footprints within a window to find before correcting target high std. dev. cell. Default is **3**.
  * --prefAlgm - The preferred algorithm to use to fill the newGround array at low std. dev. footprints. Default is **1**.
  * --forceToWave - Flag to force the chosen *--updateMethod* to return an identified peak in the waveform when running ```updateGround()```. Default is **False**.
  * --noUpdatePlots - Flag to skip writing newGround error histogram and associated rasters when running ```updateGround()```. Default is **False**.
  * --writeCoords - Flag to write the coordinates of large newGroundError footprints to file when running ```updateGround()```. Default is **False**.

An example command to load the 98% beam sensitivity data from the 30 m grid at Nouragues and apply the most effective hybrid method, without generating any plots and simply printing results to the terminal, would be:

> ```$ python3 groundFinder.py --suppress --update --updateMethod hybrid --noUpdatePlots --varScale --sdThresh 1 --fThresh 3 --covThresh 98 --gridSize 30 --site nouragues```

### ```coverStats.py```

This is the first script developed to work with simulated data that had not had noise added, and therefore had not been denoised, by ```gediMetric```. It takes the ```gediMetric``` output of raw simulated waveforms and uses the statistics of canopy cover generated from the ALS data alone (i.e., 'truth'). **Requires further edits in current form.**
